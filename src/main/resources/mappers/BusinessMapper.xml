<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.deft.crud.business.model.dao.BusinessMapper">

	<resultMap type="com.deft.crud.business.model.dto.BusinessChanceDTO"
			   id="businessChanceResultMap">
		<id property="businessChanceNo" column="BUSINESS_CHANCE_NO" />
		<result property="progressStatus" column="PROGRESS_STATUS" />
		<result property="salesLevel" column="SALES_LEVEL" />
		<result property="successPosibillity" column="SUCCESS_POSIBILLITY" />
		<result property="businessTitle" column="BUSINESS_TITLE" />
		<result property="dueDate" column="DUE_DATE" />
		<result property="empName" column="EMP_NAME" />
		<result property="empNo" column="EMP_NO" />
		<result property="customerName" column="CUSTOMER_NAME" />
		<result property="customerNo" column="CUSTOMER_NO" />
		<result property="productName" column="PRODUCT_NAME" />
		<result property="customerCompanyName" column="COMPANY_NAME" />
	</resultMap>

	<resultMap type="com.deft.crud.business.model.dto.BusinessActivityDTO"
			   id="businessActivityResultMap">
		<id property="customerNo" column="CUSTOMER_NO" />
		<result property="customerName" column="CUSTOMER_NAME" />
		<result property="activityNo" column="ACTIVITY_NO" />
		<result property="activityName" column="ACTIVITY_NAME" />
		<result property="customerNo" column="CUSTOMER_NO" />
		<result property="empNo" column="EMP_NO" />
		<result property="empName" column="EMP_NAME" />
		<result property="managerNo" column="MANAGER_NO" />
		<result property="businessSubject" column="BUSINESS_SUBJECT" />
		<result property="businessType" column="BUSINESS_TYPE" />
		<result property="businessLocation" column="BUSINESS_LOCATION" />
		<result property="businessPurpose" column="BUSINESS_PURPOSE" />
		<result property="businessContents" column="BUSINESS_CONTENTS" />
		<result property="writingTime" column="WRITING_TIME" />
		<result property="activityStartTime" column="ACTIVITY_START_TIME" />
		<result property="activityEndTime" column="ACTIVITY_END_TIME" />
	</resultMap>

	<resultMap type="com.deft.crud.business.model.dto.BusinessChanceHistoryDTO"
			   id="businessChanceChangeHistoryResultMap">
		<id property="businessChanceNo" column="BUSINESS_CHANCE_NO" />
		<result property="businessChanceHisNo" column="BUSINESS_CHANCE_HIS_NO" />
		<result property="progressStatus" column="PROGRESS_STATUS" />
		<result property="salesLevel" column="SALES_LEVEL" />
		<result property="successPosibillity" column="SUCCESS_POSIBILLITY" />
		<result property="empName" column="EMP_NAME" />
		<result property="businessChanceChangeDate" column="BUSINESS_CHANCE_CHANGE_DATE" />
	</resultMap>

	<!-- 영업기회 목록 조회(담당자 or 사원) --> 
	<select id="selectBusinessChanceAll" resultMap="businessChanceResultMap"
			parameterType="com.deft.crud.member.model.service.UserImpl">
		SELECT /* com.deft.crud.business.model.dao.BusinessMapper#selectBusinessChanceAll */
		       A.BUSINESS_CHANCE_NO
		     , A.PROGRESS_STATUS
		     , A.SALES_LEVEL
		     , A.SUCCESS_POSIBILLITY
		     , A.BUSINESS_TITLE
		     , A.DUE_DATE
		     , C.EMP_NAME
		     , A.EMP_NO
		     , B.CUSTOMER_NAME
		     , A.CUSTOMER_NO
		     , C.MANAGER_NO
		  FROM TBL_BUSINESS_CHANCE A
		  JOIN TBL_CUSTOMER B ON (A.CUSTOMER_NO = B.CUSTOMER_NO)
		  JOIN TBL_EMP_INFO C ON (A.EMP_NO = C.EMP_NO)
		<choose>
			<when test="authority == '담당자'">
				WHERE C.MANAGER_NO = #{ empNo }
			</when>
			<when test="authority != '담당자'">
				WHERE A.EMP_NO = #{ empNo }
			</when>
		</choose>
		ORDER BY A.DUE_DATE DESC
	</select>

	<!-- 영업기회 진행상태별 목록 조회(담당자 or 사원) -->
	<select id="selectBusinessChanceByStatus" resultMap="businessChanceResultMap"
		    parameterType="com.deft.crud.member.model.service.UserImpl">
		SELECT /* com.deft.crud.business.model.dao.BusinessMapper#selectBusinessChanceByStatus */
		       A.BUSINESS_CHANCE_NO
		     , A.PROGRESS_STATUS
		     , A.SALES_LEVEL
		     , A.SUCCESS_POSIBILLITY
		     , A.BUSINESS_TITLE
		     , A.DUE_DATE
		     , C.EMP_NAME
		     , A.EMP_NO
		     , B.CUSTOMER_NAME
		     , A.CUSTOMER_NO
		     , C.MANAGER_NO
		  FROM TBL_BUSINESS_CHANCE A
		  JOIN TBL_CUSTOMER B ON (A.CUSTOMER_NO = B.CUSTOMER_NO)
		  JOIN TBL_EMP_INFO C ON (A.EMP_NO = C.EMP_NO)
		<choose>
			<when test="userInfo.authority == '담당자'">
				WHERE C.MANAGER_NO = #{ userInfo.empNo }
			</when>
			<when test="userInfo.authority != '담당자'">
				WHERE A.EMP_NO = #{ userInfo.empNo }
			</when>
		</choose>
		<choose>
			<when test="businessChanceStatus == 'all'">
      		</when>
      		<when test="businessChanceStatus == 'progress'">
                AND A.PROGRESS_STATUS = '진행중'
         	</when>
         	<when test="businessChanceStatus == 'success'">
                AND A.PROGRESS_STATUS = '성공'
         	</when>
         	<when test="businessChanceStatus == 'postpone'">
                AND A.PROGRESS_STATUS = '보류중'
         	</when>
         	<when test="businessChanceStatus == 'failed'">
                AND A.PROGRESS_STATUS = '실패'
         	</when>
		</choose>
		  ORDER BY A.DUE_DATE DESC
	</select>

	<!-- 고객번호로 해당 고객에 대한 영업활동기록 조회 -->
	<select id="selectActivityListByNo" resultMap="businessActivityResultMap">
		SELECT /* com.deft.crud.business.model.dao.BusinessMapper#selectBasicInfoByNo */
		       A.ACTIVITY_NO
		     , A.BUSINESS_SUBJECT
             , C.CUSTOMER_NAME
	     	 , B.EMP_NAME
		     , A.WRITING_TIME
		     , A.ACTIVITY_START_TIME
		  FROM TBL_BUSINESS_ACTIVITY A
		  JOIN TBL_CUSTOMER C ON(A.CUSTOMER_NO = C.CUSTOMER_NO)
		  JOIN TBL_EMP_INFO B ON(C.EMP_NO = B.EMP_NO)
		 WHERE A.CUSTOMER_NO = #{ customerNo }
	</select>

	<!-- 영업기회번호로 해당 영업기회 정보 조회 -->
	<select id="selectChanceInfoByNo" resultMap="businessChanceResultMap">
		SELECT /* com.deft.crud.business.model.dao.BusinessMapper#selectBasicInfoByNo */
		       A.BUSINESS_CHANCE_NO
		     , A.BUSINESS_TITLE
		     , A.PROGRESS_STATUS
	   	     , B.EMP_NAME
		     , F.COMPANY_NAME
		     , C.CUSTOMER_NAME
		     , A.SALES_LEVEL
		     , A.SUCCESS_POSIBILLITY
		     , LISTAGG(E.PRODUCT_NAME, ', ') WITHIN GROUP (ORDER BY E.PRODUCT_NO) AS PRODUCT_NAME
		     , A.DUE_DATE
		 FROM TBL_BUSINESS_CHANCE A
		 LEFT JOIN TBL_EMP_INFO B ON(A.EMP_NO = B.EMP_NO)
		 LEFT JOIN TBL_CUSTOMER C ON(A.CUSTOMER_NO = C.CUSTOMER_NO)
		 LEFT JOIN TBL_CUSTOMER_PRODUCT D ON(C.CUSTOMER_NO = D.CUSTOMER_NO)
		 LEFT JOIN TBL_PRODUCT E ON(D.PRODUCT_NO = E.PRODUCT_NO)
		 LEFT JOIN TBL_CUSTOMER_COMPANY F ON(C.CUSTOMER_COMPANY_NO = F.CUSTOMER_COMPANY_NO)
		WHERE BUSINESS_CHANCE_NO = #{ businessChanceNo }
		GROUP BY A.BUSINESS_CHANCE_NO
		       , A.BUSINESS_TITLE
		       , A.PROGRESS_STATUS
		       , B.EMP_NAME
		       , F.COMPANY_NAME
		       , C.CUSTOMER_NAME
		       , A.SALES_LEVEL
		       , A.SUCCESS_POSIBILLITY
		       , A.DUE_DATE
	</select>


	<!-- 영업상태별 영업기회 목록조회 -->
	<select id="selectChanceHistoryByNo" resultMap="businessChanceChangeHistoryResultMap">
		SELECT /* com.deft.crud.business.model.dao.BusinessMapper#selectChanceHistoryByNo */
		       B.BUSINESS_CHANCE_CHANGE_DATE
		     , A.BUSINESS_CHANCE_NO
		     , B.BUSINESS_CHANCE_HIS_NO
		     , C.EMP_NAME
		     , A.PROGRESS_STATUS
		     , A.SALES_LEVEL
		     , A.SUCCESS_POSIBILLITY
		  FROM TBL_BUSINESS_CHANCE A
		  JOIN TBL_BUSINESS_CHANCE_HIS B ON(A.BUSINESS_CHANCE_NO =  B.BUSINESS_CHANCE_NO)
		  JOIN TBL_EMP_INFO C ON(A.EMP_NO = C.EMP_NO)
		 WHERE A.BUSINESS_CHANCE_NO = #{ businessChanceNo }
		 ORDER BY B.BUSINESS_CHANCE_CHANGE_DATE
	</select>

	<!-- 전체영업활동 조회 -->
	<select id="selectActivityAll" resultMap="businessActivityResultMap"
			parameterType="com.deft.crud.member.model.service.UserImpl">
		SELECT /* com.deft.crud.business.model.dao.BusinessMapper#selectBasicInfoByNo */
		       A.ACTIVITY_NO
		     , A.BUSINESS_SUBJECT
		     , B.EMP_NAME
		     , B.EMP_NO
		     , B.MANAGER_NO
		     , C.CUSTOMER_NAME
		     , A.WRITING_TIME
		     , A.ACTIVITY_START_TIME
		     , A.ACTIVITY_END_TIME
		  FROM TBL_BUSINESS_ACTIVITY A
		  LEFT JOIN TBL_CUSTOMER C ON(A.CUSTOMER_NO = C.CUSTOMER_NO)
		  LEFT JOIN TBL_EMP_INFO B ON(C.EMP_NO = B.EMP_NO)
		<choose>
			<when test="authority == '담당자'">
				WHERE B.MANAGER_NO = #{ empNo }
			</when>
			<when test="authority != '담당자'">
				WHERE B.EMP_NO = #{ empNo }
			</when>
		</choose>
		ORDER BY A.WRITING_TIME DESC
	</select>

</mapper>